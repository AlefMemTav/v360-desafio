%%{init: {"theme":"base", "themeVariables": {"background":"#ffffff"}}}%%
graph TD
    %% --- DefiniÃ§Ã£o dos NÃ³s ---
    
    subgraph Client_Side ["ğŸ“± Client Side (Front-End)"]
        Browser["ğŸ’» Browser / App<br>(React/JS/HTML5)"]
    end

    subgraph AWS_Cloud ["â˜ï¸ V360 Cloud Infrastructure (AWS)"]
        style AWS_Cloud fill:#f2f2f2,stroke:#orange,stroke-width:2px
        
        subgraph App_Layer ["âš™ï¸ Application Layer"]
            Rails_API["ğŸ’ Rails API<br>(REST & WebSocket)"]
            Sidekiq["ğŸ‘· Sidekiq Worker<br>(Job Processing)"]
        end
        
        subgraph Data_Layer ["ğŸ—„ï¸ Data Layer"]
            Redis[("ğŸš€ Redis<br>(Cache & Pub/Sub)")]
            Postgres[("ğŸ˜ PostgreSQL<br>(PersistÃªncia)")]
        end
    end

    subgraph External_Services ["ğŸŒ External Services"]
        OpenAI["ğŸ¤– AI Service<br>(LLM Model)"]
        SEFAZ["ğŸ¢ SEFAZ / Gov<br>(Notas Fiscais)"]
    end

    %% --- ConexÃµes ---
    
    %% Fluxo do Cliente
    Browser <==>|HTTPS / WSS| Rails_API
    
    %% Fluxo da AplicaÃ§Ã£o
    Rails_API -->|Read/Write| Postgres
    Rails_API -->|Enqueue Jobs| Redis
    
    %% Fluxo do Worker (AssÃ­ncrono)
    Redis -->|Dequeue Jobs| Sidekiq
    Sidekiq -->|Salva Resultados| Postgres
    
    %% NotificaÃ§Ã£o em Tempo Real (ActionCable)
    Sidekiq -.->|Pub Result| Redis
    Redis -.->|Sub Notification| Rails_API

    %% IntegraÃ§Ãµes Externas
    Sidekiq <-->|API Request| OpenAI
    Sidekiq -.->|ValidaÃ§Ã£o| SEFAZ

    %% --- EstilizaÃ§Ã£o ---
    classDef tech fill:#fff,stroke:#333,stroke-width:2px;
    class Browser,Rails_API,Sidekiq,Redis,Postgres,OpenAI,SEFAZ tech;
    
    %% Cores EspecÃ­ficas
    style Rails_API stroke:#CC0000,stroke-width:3px
    style Sidekiq stroke:#7f1016,stroke-width:3px
    style Postgres stroke:#336791,stroke-width:3px
    style Redis stroke:#D81C26,stroke-width:3px